[
  {
    "id" : "672a7acb-bc8e-40a0-83eb-16e0f200b03d",
    "prId" : 1883,
    "comments" : [
      {
        "id" : "604b00aa-d8ea-492a-a2e5-f8392af895c8",
        "parentId" : null,
        "author" : {
          "login" : "jberthold-da",
          "name" : "Jost Berthold",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/28879196?u=41dee6fb7ab2761a566b324e2f4e5ad9b577ae0e&v=4"
        },
        "body" : "Functions could have no (explicitly-stated) type but a doc comment.\r\n(as long as we still use the _parser_ AST... the type checker will give every function a type)",
        "createdAt" : "2019-06-26T11:14:47Z",
        "updatedAt" : "2019-06-26T11:19:31Z",
        "lastEditedBy" : {
          "login" : "jberthold-da",
          "name" : "Jost Berthold",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/28879196?u=41dee6fb7ab2761a566b324e2f4e5ad9b577ae0e&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "c862017e-d619-48a4-9861-936b617bb3b0",
        "parentId" : "604b00aa-d8ea-492a-a2e5-f8392af895c8",
        "author" : null,
        "body" : "Ah, makes sense! We should probably switch to typechecker AST like you were saying.",
        "createdAt" : "2019-06-26T11:35:35Z",
        "updatedAt" : "2019-06-26T11:35:35Z",
        "lastEditedBy" : null,
        "tags" : [
        ]
      },
      {
        "id" : "bbe98d4b-cb80-47d8-af25-6bbc8087a8ae",
        "parentId" : "604b00aa-d8ea-492a-a2e5-f8392af895c8",
        "author" : {
          "login" : "jberthold-da",
          "name" : "Jost Berthold",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/28879196?u=41dee6fb7ab2761a566b324e2f4e5ad9b577ae0e&v=4"
        },
        "body" : "Maybe worth replacing the `FIXME`s by explanations?",
        "createdAt" : "2019-06-26T21:33:38Z",
        "updatedAt" : "2019-06-26T21:33:38Z",
        "lastEditedBy" : {
          "login" : "jberthold-da",
          "name" : "Jost Berthold",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/28879196?u=41dee6fb7ab2761a566b324e2f4e5ad9b577ae0e&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "023585b3d078dac3a9410a8839a58cf2b50fd672",
    "line" : 169,
    "diffHunk" : "@@ -150,71 +155,44 @@ fieldTable fds = T.unlines $ -- NB final empty line is essential and intended\n                 , \"  - Type\"\n                 , \"  - Description\" ]\n     fieldRows = concat\n-       [ [ prefix \"* - \" $ escapeTr_ fd_name\n+       [ [ prefix \"* - \" $ escapeTr_ (unFieldname fd_name)\n          , prefix \"  - \" $ type2rst fd_type\n-         , prefix \"  - \" $ maybe \" \" (markdownToRst . T.unwords . T.lines) fd_descr ]\n+         , prefix \"  - \" $ maybe \" \" (docTextToRst . DocText . T.unwords . T.lines . unDocText) fd_descr ] -- FIXME: this makes no sense\n        | FieldDoc{..} <- fds ]\n \n-\n--- | Render fields as a table, like this:\n--- >  ============ ==============================\n--- >  **Field**    **Type/Description**\n--- >  ============ ==============================\n--- >  **anA**      | *a*\n--- >  **another**  | *a*\n--- >               | another a\n--- >  **andText**  | *Text*\n--- >               | and text\n--- >  ============ ==============================\n-_fieldTableVerbatim :: [FieldDoc] -> T.Text\n-_fieldTableVerbatim []  = \"(no fields)\"\n-_fieldTableVerbatim fds = header <> fieldRows <> equalLines\n-  where\n-    equalLines = T.unwords (map (flip T.replicate \"-\") [fLen, 30])\n-                 -- 30 because last overline can be shorter\n-    fLen = 4 + (maximum $ map T.length $ fieldHdr : map fd_name fds)\n-           -- +4 for field names in bold face\n-    fieldHdr = \"Field\"\n-    header = T.unlines\n-      [ equalLines\n-      , adjust fLen (enclosedIn \"**\" fieldHdr) <> \" \" <> \"**Type/Description**\"\n-      , equalLines\n-      ]\n-    fieldRows = T.unlines\n-      [ adjust fLen (enclosedIn \"**\" fd_name) <> \" | \"\n-        <> enclosedIn \"*\" (type2rst fd_type)\n-        <> maybe \"\" (\\d -> \"\\n\" <> indent (fLen + 1) (prefix \"| \" (markdownToRst d))) fd_descr\n-      | FieldDoc{..} <- fds ]\n-\n -- | Render a type. Nested type applications are put in parentheses.\n type2rst :: Type -> T.Text\n type2rst = f (0 :: Int)\n   where\n     -- 0 = no brackets\n     -- 1 = brackets around function\n     -- 2 = brackets around function AND application\n-    f _ (TypeApp n []) = n\n-    f i (TypeApp n as) = (if i >= 2 then inParens else id) $ T.unwords (n : map (f 2) as)\n+    f _ (TypeApp n []) = unTypename n\n+    f i (TypeApp n as) = (if i >= 2 then inParens else id) $ T.unwords (unTypename n : map (f 2) as)\n     f i (TypeFun ts) = (if i >= 1 then inParens else id) $ T.intercalate \" -> \" $ map (f 1) ts\n     f _ (TypeList t1) = \"[\" <> f 0 t1 <> \"]\"\n     f _ (TypeTuple ts) = \"(\" <> T.intercalate \", \" (map (f 0) ts) <>  \")\"\n \n \n fct2rst :: Modulename -> FunctionDoc -> T.Text\n-fct2rst md_name  FunctionDoc{..} =\n-  renderAnchor (functionAnchor md_name fct_name fct_type) <> \"\\n\"\n-  <> enclosedIn \"**\" (if isAlpha (T.head fct_name) then fct_name else inParens fct_name) <> \"\\n  : \"\n-  <> maybe \"\" ((<> \" => \") . type2rst) fct_context\n-  <> maybe \"\" ((<> \"\\n\\n\") . type2rst) fct_type\n-  <> maybe \"\" (indent 2 . markdownToRst) fct_descr\n-  <> \"\\n\"\n+fct2rst md_name  FunctionDoc{..} = T.unlines\n+    [ renderAnchor (functionAnchor md_name fct_name fct_type)\n+    , enclosedIn \"**\" (wrapOp (unFieldname fct_name))\n+    , T.concat\n+        [ \"  : \"\n+        , maybe \"\" ((<> \" => \") . type2rst) fct_context\n+        , maybe \"\" ((<> \"\\n\\n\") . type2rst) fct_type\n+            -- FIXME: when would a function not have a type?"
  },
  {
    "id" : "c6292e71-aae4-4db4-b175-a368c10ee020",
    "prId" : 1883,
    "comments" : [
      {
        "id" : "702ec3a7-d25f-4b0a-9ea0-7c7713593c16",
        "parentId" : null,
        "author" : {
          "login" : "jberthold-da",
          "name" : "Jost Berthold",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/28879196?u=41dee6fb7ab2761a566b324e2f4e5ad9b577ae0e&v=4"
        },
        "body" : "That construction `unwords . lines` might seem funny... the idea was to ensure the documentation text is a single line. Otherwise we need to  indent it correctly, which is a bit fiddly. \r\n\r\nHowever, it might be better to do that. As a principle, we should retain the line breaks in doc.text over multiple lines. More important for doc.s on modules and top-level declarations, though.  \r\n ",
        "createdAt" : "2019-06-26T11:19:12Z",
        "updatedAt" : "2019-06-26T11:19:31Z",
        "lastEditedBy" : {
          "login" : "jberthold-da",
          "name" : "Jost Berthold",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/28879196?u=41dee6fb7ab2761a566b324e2f4e5ad9b577ae0e&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "530eb363-5369-4613-8f17-05ea56e90f74",
        "parentId" : "702ec3a7-d25f-4b0a-9ea0-7c7713593c16",
        "author" : null,
        "body" : "Yeah, makes sense. I was thinking of introducing an intermediate representation in Render.RST (and Render.Markdown which has the same problems) to make it easier to indent things correctly. Some kind of \"rendered doc\" IR that can be converted to Rst or Markdown easily. Because right now there's a lot of duplication between the output modes of damldoc, and the same issues cropping up over and over again.",
        "createdAt" : "2019-06-26T11:59:55Z",
        "updatedAt" : "2019-06-26T12:01:37Z",
        "lastEditedBy" : null,
        "tags" : [
        ]
      }
    ],
    "commit" : "023585b3d078dac3a9410a8839a58cf2b50fd672",
    "line" : 104,
    "diffHunk" : "@@ -150,71 +155,44 @@ fieldTable fds = T.unlines $ -- NB final empty line is essential and intended\n                 , \"  - Type\"\n                 , \"  - Description\" ]\n     fieldRows = concat\n-       [ [ prefix \"* - \" $ escapeTr_ fd_name\n+       [ [ prefix \"* - \" $ escapeTr_ (unFieldname fd_name)\n          , prefix \"  - \" $ type2rst fd_type\n-         , prefix \"  - \" $ maybe \" \" (markdownToRst . T.unwords . T.lines) fd_descr ]\n+         , prefix \"  - \" $ maybe \" \" (docTextToRst . DocText . T.unwords . T.lines . unDocText) fd_descr ] -- FIXME: this makes no sense"
  }
]