[
  {
    "id" : "880a6143-9f2f-4fda-8f32-e9763d5b08d5",
    "prId" : 7776,
    "comments" : [
      {
        "id" : "399c03a0-8f2f-4e1a-9d90-7c9795a36fad",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Can we reference this through `${google_project_iam_custom_role.periodic-killer.id}`?",
        "createdAt" : "2020-10-22T09:39:22Z",
        "updatedAt" : "2020-10-22T10:02:55Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "c766d8d2-22a9-4b33-955f-9b92ded6911f",
        "parentId" : "399c03a0-8f2f-4e1a-9d90-7c9795a36fad",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "Yes we can. Thanks! No clue why I did not do that at the time.",
        "createdAt" : "2020-10-22T10:01:56Z",
        "updatedAt" : "2020-10-22T10:02:55Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "92d0371583ea3d2f10e453ad5a8a3054d8fd1846",
    "line" : null,
    "diffHunk" : "@@ -8,16 +8,26 @@ resource \"google_service_account\" \"periodic-killer\" {\n   account_id = \"periodic-killer\"\n }\n \n+locals {\n+  accounts_that_can_kill_machines = [\n+    # should reference google_project_iam_custom_role.periodic-killer.id or\n+    # something, but for whatever reason that's not exposed.\n+    \"serviceAccount:${google_service_account.periodic-killer.email}\",\n+\n+    \"user:gary.verhaegen@digitalasset.com\",\n+    \"user:moritz.kiefer@digitalasset.com\",\n+  ]\n+}\n+\n resource \"google_project_iam_member\" \"periodic-killer\" {\n-  # should reference google_project_iam_custom_role.periodic-killer.id or\n-  # something, but for whatever reason that's not exposed.\n-  role   = \"projects/da-dev-gcp-daml-language/roles/killCiNodesEveryNight\"\n-  member = \"serviceAccount:${google_service_account.periodic-killer.email}\"\n+  count  = \"${length(local.accounts_that_can_kill_machines)}\"\n+  role   = \"projects/da-dev-gcp-daml-language/roles/killCiNodes\""
  },
  {
    "id" : "a801a4ec-14ab-48b5-92fc-f368e7263527",
    "prId" : 5235,
    "comments" : [
      {
        "id" : "cddc6e99-21ee-4915-bc50-a46405d19e1a",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Why the escape here?",
        "createdAt" : "2020-03-27T09:46:56Z",
        "updatedAt" : "2020-03-27T09:48:20Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "f3cc4fc9-0e99-486f-9a4c-b24d112eadb0",
        "parentId" : "cddc6e99-21ee-4915-bc50-a46405d19e1a",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "This is creating the cron file (`cat <<CRON >> ...` on liine 60). We escape because we want the `date` command to run as part of the cron, not as part of creating the cron file (which would hardcode the machine creation time in the `periodic-kill.sh` file).",
        "createdAt" : "2020-03-27T10:16:15Z",
        "updatedAt" : "2020-03-27T10:16:16Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "923c37c6-a6a2-4888-95ca-efff81aba3b1",
        "parentId" : "cddc6e99-21ee-4915-bc50-a46405d19e1a",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Oh I missed that this was in the context of the `cat`, thanks!",
        "createdAt" : "2020-03-27T10:26:06Z",
        "updatedAt" : "2020-03-27T10:26:07Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "90b9658cdea7b6815136a96f8cb36e8459471e54",
    "line" : 9,
    "diffHunk" : "@@ -55,23 +55,34 @@ set -euxo pipefail\n apt-get update\n apt-get install -y jq\n \n+echo \"$(date -Is -u) boot\" > /root/log\n+\n cat <<CRON > /root/periodic-kill.sh\n #!/usr/bin/env bash\n set -euo pipefail\n+echo \"\\$(date -Is -u) start\""
  },
  {
    "id" : "8546daaa-d029-4153-8ef0-4371bf3c4e21",
    "prId" : 5235,
    "comments" : [
      {
        "id" : "3ff459eb-dec4-442f-b06f-c968f26007cf",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Same here why are we escaping this?",
        "createdAt" : "2020-03-27T09:47:55Z",
        "updatedAt" : "2020-03-27T09:48:20Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "f3a052a8-b042-4487-9e69-0bf69283e53a",
        "parentId" : "3ff459eb-dec4-442f-b06f-c968f26007cf",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Answering my own question based on the one above, we are also in the context of a `cat`.",
        "createdAt" : "2020-03-27T10:27:01Z",
        "updatedAt" : "2020-03-27T10:27:02Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "90b9658cdea7b6815136a96f8cb36e8459471e54",
    "line" : 23,
    "diffHunk" : "@@ -55,23 +55,34 @@ set -euxo pipefail\n apt-get update\n apt-get install -y jq\n \n+echo \"$(date -Is -u) boot\" > /root/log\n+\n cat <<CRON > /root/periodic-kill.sh\n #!/usr/bin/env bash\n set -euo pipefail\n+echo \"\\$(date -Is -u) start\"\n \n PREFIX=vsts-\n MACHINES=\\$(/snap/bin/gcloud compute instances list --format=json | jq -c '.[] | select(.name | startswith(\"'\\$PREFIX'\")) | [.name, .zone]')\n \n for m in \\$MACHINES; do\n-    /snap/bin/gcloud -q compute instances delete \\$(echo \\$m | jq -r '.[0]') --zone=\\$(echo \\$m | jq -r '.[1]')\n+    MACHINE_NAME=\\$(echo \\$m | jq -r '.[0]')\n+    MACHINE_ZONE=\\$(echo \\$m | jq -r '.[1]')\n+    # We do not want to abort the script on error here because failing to\n+    # reboot one machine should not prevent trying to reboot the others.\n+    /snap/bin/gcloud -q compute instances delete \\$MACHINE_NAME --zone=\\$MACHINE_ZONE || true\n done\n+\n+echo \"\\$(date -Is -u) end\""
  },
  {
    "id" : "98257f27-14cb-43a7-b39b-d3b133a20f26",
    "prId" : 4455,
    "comments" : [
      {
        "id" : "c4b30252-dd18-4de6-af04-09707e79f0b8",
        "parentId" : null,
        "author" : {
          "login" : "hurryabit",
          "name" : "Martin Huschenbett",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/11665611?u=7dbd00d5e7ea53919ed31dc4200f602ebca91c8f&v=4"
        },
        "body" : "Does that mean we're running the job 4 am UTC or local time?",
        "createdAt" : "2020-02-10T11:47:18Z",
        "updatedAt" : "2020-02-10T11:47:34Z",
        "lastEditedBy" : {
          "login" : "hurryabit",
          "name" : "Martin Huschenbett",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/11665611?u=7dbd00d5e7ea53919ed31dc4200f602ebca91c8f&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "18670dea-e858-407f-b915-67e05ee4c4d2",
        "parentId" : "c4b30252-dd18-4de6-af04-09707e79f0b8",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "UTC.",
        "createdAt" : "2020-02-11T00:02:32Z",
        "updatedAt" : "2020-02-11T00:02:32Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "e7dad51950182b6a5346068c4f807fc72ae7b63b",
    "line" : 21,
    "diffHunk" : "@@ -70,7 +70,7 @@ CRON\n chmod +x /root/periodic-kill.sh\n \n cat <<CRONTAB >> /etc/crontab\n-*/30 * * * * root /root/periodic-kill.sh\n+0 4 * * * root /root/periodic-kill.sh"
  }
]