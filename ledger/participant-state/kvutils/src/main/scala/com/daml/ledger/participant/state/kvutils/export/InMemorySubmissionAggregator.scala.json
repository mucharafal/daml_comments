[
  {
    "id" : "06a80a10-34d7-4b8e-a9c9-cf98ea4e7412",
    "prId" : 7265,
    "comments" : [
      {
        "id" : "2b4cf58f-83ac-4c38-91fa-368352d4de82",
        "parentId" : null,
        "author" : {
          "login" : "fabiotudone-da",
          "name" : null,
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/59609563?u=a3a8ac844c9aacd1d1bd319a77d1d0ac60d701a3&v=4"
        },
        "body" : "Why do you need to sort?",
        "createdAt" : "2020-08-31T15:08:52Z",
        "updatedAt" : "2020-09-01T09:44:56Z",
        "lastEditedBy" : {
          "login" : "fabiotudone-da",
          "name" : null,
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/59609563?u=a3a8ac844c9aacd1d1bd319a77d1d0ac60d701a3&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "60d49d12-77fc-4f1e-93aa-1699fd505e15",
        "parentId" : "2b4cf58f-83ac-4c38-91fa-368352d4de82",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "This is done in [`820b782` (#7265)](https://github.com/digital-asset/daml/pull/7265/commits/820b7821282c949e2bc4e303d0bb9c73a771d770), which moves this logic to aggregation instead of doing it at the end.\r\n\r\nI'm not sure why we sort the write set on export, but we always have.",
        "createdAt" : "2020-08-31T15:24:21Z",
        "updatedAt" : "2020-09-01T09:44:56Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "40fc5dcb-6570-41b0-beda-50fc22b98e30",
        "parentId" : "2b4cf58f-83ac-4c38-91fa-368352d4de82",
        "author" : {
          "login" : "fabiotudone-da",
          "name" : null,
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/59609563?u=a3a8ac844c9aacd1d1bd319a77d1d0ac60d701a3&v=4"
        },
        "body" : "Hmm, I see. I guess this might or not be a problem in replay tests for non-determinism, depending on how they work. @miklos-da What do you think?",
        "createdAt" : "2020-08-31T15:37:36Z",
        "updatedAt" : "2020-09-01T09:44:56Z",
        "lastEditedBy" : {
          "login" : "fabiotudone-da",
          "name" : null,
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/59609563?u=a3a8ac844c9aacd1d1bd319a77d1d0ac60d701a3&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "7bd5a04c-5a49-4460-b213-8e56dcb6412f",
        "parentId" : "2b4cf58f-83ac-4c38-91fa-368352d4de82",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "I agree with this logic and would rather not sort them. If I can get the go-ahead to remove this logic, I'm happy to. I'd rather do it in this PR so we can get it released. However, I'm not comfortable making this decision solo; I'd like to get a thumbs-up from both you and @miklos-da.",
        "createdAt" : "2020-09-01T09:39:09Z",
        "updatedAt" : "2020-09-01T09:44:56Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "d0f30226-72d9-41a6-814c-7657d697aad8",
        "parentId" : "2b4cf58f-83ac-4c38-91fa-368352d4de82",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "FYI, I tried removing sorting on both the write side and the integrity checker, and I get a bunch of ordering errors. So it's (unfortunately) necessary, at least for now.\r\n\r\nI think removing it is out of scope for this PR.",
        "createdAt" : "2020-09-01T14:16:11Z",
        "updatedAt" : "2020-09-01T14:16:12Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "99dd3e84-078f-4863-858e-b9b641160185",
        "parentId" : "2b4cf58f-83ac-4c38-91fa-368352d4de82",
        "author" : {
          "login" : "miklos-da",
          "name" : "Miklos",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/57664299?v=4"
        },
        "body" : "OK, let's revisit this later. We generally sort write-sets before passing them e.g. to the storage layer to get deterministic results.",
        "createdAt" : "2020-09-02T09:54:19Z",
        "updatedAt" : "2020-09-02T10:22:17Z",
        "lastEditedBy" : {
          "login" : "miklos-da",
          "name" : "Miklos",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/57664299?v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "ac8921a780ac376a2ef73b6b5139530185f6bf5a",
    "line" : 31,
    "diffHunk" : "@@ -12,23 +14,26 @@ final class InMemorySubmissionAggregator(submissionInfo: SubmissionInfo, writer:\n \n   import InMemorySubmissionAggregator._\n \n-  private val buffer = mutable.ListBuffer.empty[WriteItem]\n+  private val aggregate = mutable.SortedMap.empty[Key, Value]\n \n-  override def addChild(): WriteSetBuilder = new InMemoryWriteSetBuilder(buffer)\n+  override def addChild(): WriteSetBuilder = new InMemoryWriteSetBuilder(aggregate)\n \n-  override def finish(): Unit = writer.write(submissionInfo, buffer)\n+  override def finish(): Unit =\n+    writer.write(submissionInfo, aggregate)\n }\n \n object InMemorySubmissionAggregator {\n \n-  final class InMemoryWriteSetBuilder(buffer: mutable.Buffer[WriteItem]) extends WriteSetBuilder {\n-    override def +=(data: WriteItem): Unit = buffer.synchronized {\n-      buffer += data\n+  final class InMemoryWriteSetBuilder private[InMemorySubmissionAggregator] (\n+      aggregate: mutable.SortedMap[Key, Value],"
  },
  {
    "id" : "214412ef-90fe-4483-96eb-dc14c1222798",
    "prId" : 7215,
    "comments" : [
      {
        "id" : "610f65f5-6a2f-47b1-885c-3be27ec0e7f4",
        "parentId" : null,
        "author" : {
          "login" : "fabiotudone-da",
          "name" : null,
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/59609563?u=a3a8ac844c9aacd1d1bd319a77d1d0ac60d701a3&v=4"
        },
        "body" : "```suggestion\r\n```",
        "createdAt" : "2020-08-25T10:53:13Z",
        "updatedAt" : "2020-08-25T15:02:13Z",
        "lastEditedBy" : {
          "login" : "fabiotudone-da",
          "name" : null,
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/59609563?u=a3a8ac844c9aacd1d1bd319a77d1d0ac60d701a3&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "b6eb4895-991a-4ec5-84f3-325f9b161d29",
        "parentId" : "610f65f5-6a2f-47b1-885c-3be27ec0e7f4",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "We don't seem to have a convention about these. As IntelliJ has added them and we favor them elsewhere in the codebase (I think as the IntelliJ default), I'd prefer not to worry about them unless we can automate the addition or removal.",
        "createdAt" : "2020-08-25T11:17:08Z",
        "updatedAt" : "2020-08-25T15:02:13Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "0020dd8e089d897ae22c94ce2643c7d7f6073b04",
    "line" : 35,
    "diffHunk" : "@@ -0,0 +1,36 @@\n+// Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package com.daml.ledger.participant.state.kvutils.export\n+\n+import com.daml.ledger.participant.state.kvutils.export.SubmissionAggregator.WriteSetBuilder\n+\n+import scala.collection.mutable\n+\n+final class InMemorySubmissionAggregator(submissionInfo: SubmissionInfo, writer: LedgerDataWriter)\n+    extends SubmissionAggregator {\n+\n+  import InMemorySubmissionAggregator._\n+\n+  private val buffer = mutable.ListBuffer.empty[WriteItem]\n+\n+  override def addChild(): WriteSetBuilder = new InMemoryWriteSetBuilder(buffer)\n+\n+  override def finish(): Unit = writer.write(submissionInfo, buffer)\n+}\n+\n+object InMemorySubmissionAggregator {\n+\n+  final class InMemoryWriteSetBuilder(buffer: mutable.Buffer[WriteItem]) extends WriteSetBuilder {\n+    override def +=(data: WriteItem): Unit = buffer.synchronized {\n+      buffer += data\n+      ()\n+    }\n+\n+    override def ++=(data: Iterable[WriteItem]): Unit = buffer.synchronized {\n+      buffer ++= data\n+      ()\n+    }\n+  }\n+"
  }
]