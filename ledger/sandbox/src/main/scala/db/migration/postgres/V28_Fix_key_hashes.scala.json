[
  {
    "id" : "001fdbe2-d036-41b4-855c-84aa903f8639",
    "prId" : 5681,
    "comments" : [
      {
        "id" : "f4093daa-df76-4aca-985e-a728d676c95c",
        "parentId" : null,
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "```suggestion\r\n        fixHash.setBinaryStream(1, hashBytes)\r\n        fixHash.setString(2, contractId)\r\n```",
        "createdAt" : "2020-04-23T10:23:17Z",
        "updatedAt" : "2020-04-23T11:01:23Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "5fa9427e1eb09d65fb0553cab0f80ef0ce7e112c",
    "line" : null,
    "diffHunk" : "@@ -0,0 +1,57 @@\n+// Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package db.migration.postgres\n+\n+import com.daml.lf.data.Ref\n+import com.daml.lf.transaction.Node.GlobalKey\n+import com.daml.platform.store.serialization.ValueSerializer\n+import org.flywaydb.core.api.migration.{BaseJavaMigration, Context}\n+\n+final class V28_Fix_key_hashes extends BaseJavaMigration {\n+\n+  private val SELECT_KEYS =\n+    \"select contract_id, template_id, create_key_value from participant_events where create_key_value is not null and create_consumed_at is not null\"\n+\n+  private val FIX_HASH =\n+    \"update participant_contracts set create_key_hash = ? where contract_id = ?\"\n+\n+  override def migrate(context: Context): Unit = {\n+    val conn = context.getConnection\n+    var selectKeys: java.sql.Statement = null\n+    var fixHash: java.sql.PreparedStatement = null\n+    var keysRows: java.sql.ResultSet = null\n+    try {\n+      fixHash = conn.prepareStatement(FIX_HASH)\n+\n+      selectKeys = conn.createStatement()\n+      keysRows = selectKeys.executeQuery(SELECT_KEYS)\n+\n+      while (keysRows.next()) {\n+        val contractId = keysRows.getString(\"contract_id\")\n+        val rawTemplateId = keysRows.getString(\"template_id\")\n+        val templateId = Ref.Identifier.assertFromString(rawTemplateId)\n+        val rawKeyValue = keysRows.getBinaryStream(\"create_key_value\")\n+        val keyValue = ValueSerializer.deserializeValue(rawKeyValue)\n+        val key = GlobalKey.assertBuild(templateId, keyValue.value)\n+        val hashBytes = key.hash.bytes.toInputStream\n+\n+        fixHash.setString(1, contractId)\n+        fixHash.setBinaryStream(2, hashBytes)"
  },
  {
    "id" : "20a9505c-e48c-4d0c-8025-ee3d7abe6171",
    "prId" : 5681,
    "comments" : [
      {
        "id" : "226de0c7-b3bc-4b42-acfb-54db19dda54f",
        "parentId" : null,
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "```suggestion\r\nfinal class V28__Fix_key_hashes extends BaseJavaMigration {\r\n```",
        "createdAt" : "2020-04-23T10:25:22Z",
        "updatedAt" : "2020-04-23T11:01:23Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "5fa9427e1eb09d65fb0553cab0f80ef0ce7e112c",
    "line" : null,
    "diffHunk" : "@@ -0,0 +1,57 @@\n+// Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+// SPDX-License-Identifier: Apache-2.0\n+\n+package db.migration.postgres\n+\n+import com.daml.lf.data.Ref\n+import com.daml.lf.transaction.Node.GlobalKey\n+import com.daml.platform.store.serialization.ValueSerializer\n+import org.flywaydb.core.api.migration.{BaseJavaMigration, Context}\n+\n+final class V28_Fix_key_hashes extends BaseJavaMigration {"
  }
]