[
  {
    "id" : "146a3257-f47c-40bf-a7f3-fe4c6bd9a809",
    "prId" : 3682,
    "comments" : [
      {
        "id" : "17ec31dc-6b1b-472e-bb0e-bf6cf8ec39c3",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/47582?v=4"
        },
        "body" : "We can get rid of the curly braces here.",
        "createdAt" : "2019-11-29T16:34:44Z",
        "updatedAt" : "2019-12-06T10:21:32Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/47582?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "1e6c4f1300f95e21d8c8f244ae99ddeb3b6b2d13",
    "line" : null,
    "diffHunk" : "@@ -28,7 +28,6 @@ import com.digitalasset.platform.sandbox.metrics.timedFuture\n import com.digitalasset.platform.sandbox.stores.ledger.LedgerEntry\n import com.digitalasset.platform.sandbox.stores.ledger.sql.SqlLedger.{\n   defaultNumberOfShortLivedConnections,\n-  defaultNumberOfStreamingConnections\n }"
  },
  {
    "id" : "26852670-bb79-41d3-bf08-796027d1c753",
    "prId" : 3553,
    "comments" : [
      {
        "id" : "8c1779dc-6fcc-4646-9f7d-b8bed0342fa5",
        "parentId" : null,
        "author" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "body" : "Return `recordTime` here.",
        "createdAt" : "2019-11-25T08:35:58Z",
        "updatedAt" : "2019-11-27T14:09:02Z",
        "lastEditedBy" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "04d3118b43225ee033b4c9bba93102cdc650df6a",
    "line" : null,
    "diffHunk" : "@@ -353,9 +370,9 @@ class JdbcIndexer private[index] (\n       case PartyAddedToParticipant(_, _, _, recordTime) => Some(recordTime)\n       case PublicPackageUploaded(_, _, _, recordTime) => Some(recordTime)\n       case TransactionAccepted(_, _, _, _, recordTime, _) => Some(recordTime)\n-      case ConfigurationChanged(_, _) => None\n-      case ConfigurationChangeRejected(_, _) => None\n-      case CommandRejected(_, _) => None\n+      case ConfigurationChanged(_, _, _, _) => None\n+      case ConfigurationChangeRejected(_, _, _, _, _) => None\n+      case CommandRejected(_, _, _) => None"
  },
  {
    "id" : "7433ca03-4d1b-4661-8cd4-c5da03188f19",
    "prId" : 3553,
    "comments" : [
      {
        "id" : "2b4054ba-c233-470b-a5dc-67f61f0bec54",
        "parentId" : null,
        "author" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "body" : "Return `recordTime` here.",
        "createdAt" : "2019-11-25T08:36:02Z",
        "updatedAt" : "2019-11-27T14:09:02Z",
        "lastEditedBy" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "04d3118b43225ee033b4c9bba93102cdc650df6a",
    "line" : null,
    "diffHunk" : "@@ -353,9 +370,9 @@ class JdbcIndexer private[index] (\n       case PartyAddedToParticipant(_, _, _, recordTime) => Some(recordTime)\n       case PublicPackageUploaded(_, _, _, recordTime) => Some(recordTime)\n       case TransactionAccepted(_, _, _, _, recordTime, _) => Some(recordTime)\n-      case ConfigurationChanged(_, _) => None\n-      case ConfigurationChangeRejected(_, _) => None\n-      case CommandRejected(_, _) => None\n+      case ConfigurationChanged(_, _, _, _) => None\n+      case ConfigurationChangeRejected(_, _, _, _, _) => None"
  },
  {
    "id" : "89165daf-9686-46f1-8d4a-c4d960399613",
    "prId" : 3553,
    "comments" : [
      {
        "id" : "fae43b37-fdaa-4182-9168-bdebfffd755a",
        "parentId" : null,
        "author" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "body" : "Return `recordTime` here.",
        "createdAt" : "2019-11-25T08:36:05Z",
        "updatedAt" : "2019-11-27T14:09:02Z",
        "lastEditedBy" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "cdc49e23-0df7-4639-8811-cc45f7ec32b3",
        "parentId" : "fae43b37-fdaa-4182-9168-bdebfffd755a",
        "author" : {
          "login" : "dajmaki",
          "name" : "Jussi Mäki",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/19684330?u=abb996187e6b472110abdd8dc3c27c4fc0140b92&v=4"
        },
        "body" : ":+1: ",
        "createdAt" : "2019-11-25T09:51:29Z",
        "updatedAt" : "2019-11-27T14:09:02Z",
        "lastEditedBy" : {
          "login" : "dajmaki",
          "name" : "Jussi Mäki",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/19684330?u=abb996187e6b472110abdd8dc3c27c4fc0140b92&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "04d3118b43225ee033b4c9bba93102cdc650df6a",
    "line" : null,
    "diffHunk" : "@@ -353,9 +370,9 @@ class JdbcIndexer private[index] (\n       case PartyAddedToParticipant(_, _, _, recordTime) => Some(recordTime)\n       case PublicPackageUploaded(_, _, _, recordTime) => Some(recordTime)\n       case TransactionAccepted(_, _, _, _, recordTime, _) => Some(recordTime)\n-      case ConfigurationChanged(_, _) => None\n-      case ConfigurationChangeRejected(_, _) => None\n-      case CommandRejected(_, _) => None\n+      case ConfigurationChanged(_, _, _, _) => None"
  },
  {
    "id" : "1a9296e6-5150-4ac9-841a-0218713bf60c",
    "prId" : 3523,
    "comments" : [
      {
        "id" : "47636e5d-ae69-4eb5-9b28-2f2ee9802747",
        "parentId" : null,
        "author" : {
          "login" : "mziolekda",
          "name" : "mziolekda",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/28315767?u=bfa7fd34d88616828ab02abda54fea595b0fde29&v=4"
        },
        "body" : "An alternative to a volatile variable would be to stamp the metrics with every time a new update is processed. \r\n\r\nI guess it doesn't make much difference because in that case we would be hitting similar synchronization mechanism (potentially a lot more expensive) inside of the metrics subsystem?",
        "createdAt" : "2019-11-20T09:15:11Z",
        "updatedAt" : "2019-11-20T13:11:31Z",
        "lastEditedBy" : {
          "login" : "mziolekda",
          "name" : "mziolekda",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/28315767?u=bfa7fd34d88616828ab02abda54fea595b0fde29&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "2377372b-849f-4541-9cae-ffbed8d276dc",
        "parentId" : "47636e5d-ae69-4eb5-9b28-2f2ee9802747",
        "author" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "body" : "So the offset is reported as a `Gauge`, which can represent any value really (ultimately `toString` will be called on it). Any other sort of metric is number based, which means we would have to convert the offset (array[long]) to a single number. Therefore I think using the gauge is more appropriate.\r\nDisclaimer: the value of the gauge is not actively pushed. it is up to the configured metrics reporter to poll the gauge at some interval.",
        "createdAt" : "2019-11-20T09:28:05Z",
        "updatedAt" : "2019-11-20T13:11:31Z",
        "lastEditedBy" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "1c18dcee-66b7-4ac9-8357-1f639d1b58f1",
        "parentId" : "47636e5d-ae69-4eb5-9b28-2f2ee9802747",
        "author" : {
          "login" : "mziolekda",
          "name" : "mziolekda",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/28315767?u=bfa7fd34d88616828ab02abda54fea595b0fde29&v=4"
        },
        "body" : "What you put into the disclaimer was what I was mostly interested in. \r\n\r\nI was wondering about the performance implications of this approach to gathering metrics, i.e. volatile var + poll. But then concluded myself that there is no free lunch and what you have done is probably as good as it gets. \"Active pushing\" or a \"volatile var\" both exert some form of protection of the state shared between the threads. Just wanted to confirm that this is also what you think.",
        "createdAt" : "2019-11-20T09:35:05Z",
        "updatedAt" : "2019-11-20T13:11:31Z",
        "lastEditedBy" : {
          "login" : "mziolekda",
          "name" : "mziolekda",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/28315767?u=bfa7fd34d88616828ab02abda54fea595b0fde29&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "51cab154-7075-4d5c-901f-b730ef4c5ce1",
        "parentId" : "47636e5d-ae69-4eb5-9b28-2f2ee9802747",
        "author" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "body" : "oh, the polling happens in any case, because usually the reporter takes a snapshot of all metrics after a configured interval and sends the data to graphite, datadog, influxdb, ...",
        "createdAt" : "2019-11-20T10:18:16Z",
        "updatedAt" : "2019-11-20T13:11:31Z",
        "lastEditedBy" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "c0256fb7ef1584aba393cfde8b761ea827189612",
    "line" : 51,
    "diffHunk" : "@@ -162,31 +163,85 @@ class JdbcIndexerFactory[Status <: InitStatus] private (loggerFactory: NamedLogg\n class JdbcIndexer private[index] (\n     initialInternalOffset: Long,\n     beginAfterExternalOffset: Option[LedgerString],\n-    ledgerDao: LedgerDao)(implicit mat: Materializer)\n+    ledgerDao: LedgerDao,\n+    metricsManager: MetricsManager)(implicit mat: Materializer)\n     extends Indexer\n     with AutoCloseable {\n \n   @volatile\n   private var headRef = initialInternalOffset\n \n+  @volatile\n+  private var lastReceivedRecordTime = Instant.now()\n+\n+  @volatile\n+  private var lastReceivedOffset: LedgerString = _"
  },
  {
    "id" : "d6981ae2-dbfa-4f9f-9afe-156fcc066b20",
    "prId" : 3080,
    "comments" : [
      {
        "id" : "2e28e271-511d-4cdc-b8c5-1c98e9d53af6",
        "parentId" : null,
        "author" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "body" : "@stefanobaghino-da: What's your take on `XyzLogging` traits vs. creating loggers by hand?",
        "createdAt" : "2019-10-02T06:51:49Z",
        "updatedAt" : "2019-10-03T15:26:22Z",
        "lastEditedBy" : {
          "login" : "gerolf-da",
          "name" : "Gerolf Seitz",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/29121423?u=f683aa614e742c653ae8c01b194905dcdef6e974&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "5da207de-65dc-4da3-b715-b029db546f82",
        "parentId" : "2e28e271-511d-4cdc-b8c5-1c98e9d53af6",
        "author" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "body" : "Easy to go either way",
        "createdAt" : "2019-10-02T11:52:03Z",
        "updatedAt" : "2019-10-03T15:26:22Z",
        "lastEditedBy" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "d95cf2c7-483f-461f-a1ac-09e0f3cf9936",
        "parentId" : "2e28e271-511d-4cdc-b8c5-1c98e9d53af6",
        "author" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "body" : "I removed the NamedLogging trait",
        "createdAt" : "2019-10-02T14:32:08Z",
        "updatedAt" : "2019-10-03T15:26:22Z",
        "lastEditedBy" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "d95f1ee782ebcf961b9c14dc7408e26e2e9e470e",
    "line" : null,
    "diffHunk" : "@@ -52,11 +52,12 @@ final abstract class Initialized extends InitStatus\n final abstract class Uninitialized extends InitStatus\n \n object JdbcIndexerFactory {\n-  def apply(): JdbcIndexerFactory[Uninitialized] = new JdbcIndexerFactory[Uninitialized]()\n+  def apply(namedLogger: NamedLogger): JdbcIndexerFactory[Uninitialized] =\n+    new JdbcIndexerFactory[Uninitialized](namedLogger)\n }\n \n-class JdbcIndexerFactory[Status <: InitStatus] private () {\n-  private val logger = LoggerFactory.getLogger(classOf[JdbcIndexer])\n+class JdbcIndexerFactory[Status <: InitStatus] private (protected val namedLogger: NamedLogger)\n+    extends NamedLogging {"
  },
  {
    "id" : "31e059f6-503a-468c-be2c-27535848f234",
    "prId" : 2425,
    "comments" : [
      {
        "id" : "436d1887-342b-46fe-9124-8ef7019b1df8",
        "parentId" : null,
        "author" : {
          "login" : "rautenrieth-da",
          "name" : "Robert Autenrieth",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/31539813?u=e5fe17e2c6f986e9ee04c5b9ca5f6a5a90d1c94a&v=4"
        },
        "body" : "This looks like a change unrelated to H2, is this a bug fix that could go to a separate PR?",
        "createdAt" : "2019-08-21T13:45:11Z",
        "updatedAt" : "2019-08-28T11:21:54Z",
        "lastEditedBy" : {
          "login" : "rautenrieth-da",
          "name" : "Robert Autenrieth",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/31539813?u=e5fe17e2c6f986e9ee04c5b9ca5f6a5a90d1c94a&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "273eb7e6-bd98-47ac-954d-91392d6834c1",
        "parentId" : "436d1887-342b-46fe-9124-8ef7019b1df8",
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "I'm also not 100% sure it's correct. I remember talking to @gerolf-da about this and that we should use the actual upload time rather than the time provided by the committer.",
        "createdAt" : "2019-08-21T14:12:32Z",
        "updatedAt" : "2019-08-28T11:21:54Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "fc03f9a4-4e90-4c94-8f2c-442fdb819b06",
        "parentId" : "436d1887-342b-46fe-9124-8ef7019b1df8",
        "author" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "body" : "I will open a separate issue for RecordTime. Multi-ledgers such as Canton and Corda are allowed to \"opt out\" of recordTime (which is being made optional for multi-ledgers). The mechansim to opt-out is to send Epoch-time instead (which Canton does by setting an recordTime fields to Timestamp.Epoch on all event types which expose recordTime.",
        "createdAt" : "2019-08-22T12:20:47Z",
        "updatedAt" : "2019-08-28T11:21:54Z",
        "lastEditedBy" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "ad2dca37-cf73-4465-9a34-d0171c70cd08",
        "parentId" : "436d1887-342b-46fe-9124-8ef7019b1df8",
        "author" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "body" : "Tracked as #2635 and removing change from this PR.",
        "createdAt" : "2019-08-22T14:48:31Z",
        "updatedAt" : "2019-08-28T11:21:54Z",
        "lastEditedBy" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "1fee0715b6e5ad68a7c644fcc1d5e65f71f5a8ed",
    "line" : null,
    "diffHunk" : "@@ -173,13 +175,12 @@ class PostgresIndexer private (\n       case PartyAddedToParticipant(party, displayName, _, _) =>\n         ledgerDao.storeParty(party, Some(displayName)).map(_ => ())(DEC)\n \n-      case PublicPackageUploaded(archive, sourceDescription, _, _) =>\n+      case PublicPackageUploaded(archive, sourceDescription, _, recordTime) =>\n         val uploadId = UUID.randomUUID().toString\n-        val uploadInstant = Instant.now()\n         val packages: List[(DamlLf.Archive, v2.PackageDetails)] = List(\n           archive -> v2.PackageDetails(\n             size = archive.getPayload.size.toLong,\n-            knownSince = uploadInstant,\n+            knownSince = recordTime.toInstant,"
  }
]