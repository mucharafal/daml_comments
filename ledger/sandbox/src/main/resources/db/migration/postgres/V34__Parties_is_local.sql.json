[
  {
    "id" : "be131912-0b85-447c-bbc7-1c998ded52d3",
    "prId" : 6382,
    "comments" : [
      {
        "id" : "37e84aa2-9efe-4944-83d3-3185be031feb",
        "parentId" : null,
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "This is tricky: this would cause all previously existing parties to be treated as local. Is that what we want to happen?",
        "createdAt" : "2020-06-17T13:46:28Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "3a58ace9-2927-4176-a477-b15b1b361d9e",
        "parentId" : "37e84aa2-9efe-4944-83d3-3185be031feb",
        "author" : {
          "login" : "daravep",
          "name" : null,
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/14316769?u=ecf84cb9190107a561ee4bec759072fdefd73269&v=4"
        },
        "body" : "I guess you are right. Right now, all parties appear as local, so the change would have only applied to new parties. We can fix the existing parties by doing the following. Keep above change, but extend it with:\r\n```\r\nUPDATE parties SET is_local = false WHERE party IN (SELECT party FROM party_entries WHERE is_local = false);\r\nALTER TABLE parties CHANGE COLUMN is_local is_local bool not null;\r\n```\r\nThat was actually also the issue: we have two party tables, parties and party_entries. I guess it would make more sense to drop one of them but I didn't dare to touch this rabbit hole, as I don't know why it is there in the first place.",
        "createdAt" : "2020-06-17T18:49:42Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "daravep",
          "name" : null,
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/14316769?u=ecf84cb9190107a561ee4bec759072fdefd73269&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "507614ce-9f96-4307-9eb4-31af1cebef12",
        "parentId" : "37e84aa2-9efe-4944-83d3-3185be031feb",
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "`parties` are allocated parties, `party_entries` represents the history of allocations. We have two because the latter keeps track of ongoing allocations (since they have to happen asynchronously) while the former tracks the state (more or less akin to contracts and transactions/events).",
        "createdAt" : "2020-06-18T07:34:41Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "af43861b-b2b3-49dc-bba0-07f04ab693e4",
        "parentId" : "37e84aa2-9efe-4944-83d3-3185be031feb",
        "author" : {
          "login" : "daravep",
          "name" : null,
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/14316769?u=ecf84cb9190107a561ee4bec759072fdefd73269&v=4"
        },
        "body" : "Why not add another column to party_entries active boolean and an appropriate index? Then the \"current state\" is given by all the party_entries that are active and the rest captures the process and the history? -1 table.",
        "createdAt" : "2020-06-18T09:06:56Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "daravep",
          "name" : null,
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/14316769?u=ecf84cb9190107a561ee4bec759072fdefd73269&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "efb941f667b1ddcd27e8da8d7740f2ea79ba5a67",
    "line" : null,
    "diffHunk" : "@@ -0,0 +1,11 @@\n+-- Copyright (c) 2019 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+-- SPDX-License-Identifier: Apache-2.0\n+\n+---------------------------------------------------------------------------------------------------\n+-- V34: Add is_local column to parties table.\n+--\n+-- This allows parties to be marked as to whether they were added locally as determined by whether\n+-- the specified participant_id matched the local participant_id.\n+---------------------------------------------------------------------------------------------------\n+\n+ALTER TABLE parties ADD COLUMN is_local bool not null default true;"
  },
  {
    "id" : "45962d14-09ac-47bb-85b9-9a94d0e191bd",
    "prId" : 6382,
    "comments" : [
      {
        "id" : "90b21cee-3d98-44e8-b480-93d730a4bdb1",
        "parentId" : null,
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "I'm not sure I understand how the party can be missing. Can you clarify what you mean by \"somehow\"?",
        "createdAt" : "2020-06-18T13:23:14Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "4282a466-3247-40e2-97fe-64ab83643d9a",
        "parentId" : "90b21cee-3d98-44e8-b480-93d730a4bdb1",
        "author" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "body" : "I meant if someone manually connected to the index database and removed rows from the `party_entries` table, e.g. to free up space. I just felt wary about setting is_local to true in the case no row is found in `party_entries` and therefore mislabeling.",
        "createdAt" : "2020-06-18T13:38:32Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "4dcd8b31-e8b5-4eb5-9eda-1978d7c5e943",
        "parentId" : "90b21cee-3d98-44e8-b480-93d730a4bdb1",
        "author" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "body" : "The fact that the index is backed by an RDBMS is an internal detail. If you start manually mangling with it instead of interacting with it with a public API you are asking for trouble. I think we should crash if the index has been corrupted.",
        "createdAt" : "2020-06-18T15:28:47Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "stefanobaghino-da",
          "name" : "Stefano Baghino",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/43749967?v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "e9157701-c169-4417-9424-9ecc9646b4f1",
        "parentId" : "90b21cee-3d98-44e8-b480-93d730a4bdb1",
        "author" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "body" : "Ok, letting the final `ALTER TABLE .. SET NOT NULL` command fail if there are uninitialized values.",
        "createdAt" : "2020-06-18T15:55:28Z",
        "updatedAt" : "2020-06-19T09:18:12Z",
        "lastEditedBy" : {
          "login" : "oliverse-da",
          "name" : "Oliver Seeliger",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/46452754?u=dd1d8e09760abe67b40a4e527a15aafe9d104d82&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "efb941f667b1ddcd27e8da8d7740f2ea79ba5a67",
    "line" : null,
    "diffHunk" : "@@ -0,0 +1,21 @@\n+-- Copyright (c) 2019 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+-- SPDX-License-Identifier: Apache-2.0\n+\n+---------------------------------------------------------------------------------------------------\n+-- V34: Add is_local column to parties table.\n+--\n+-- This allows parties to be marked as to whether they were added locally as determined by whether\n+-- the specified participant_id matched the local participant_id.\n+--\n+-- To initialize parties.is_local properly, rely on the existence of party_entries.is_local\n+-- default to parties.is_local = true only if party_entries were somehow manually deleted."
  }
]