[
  {
    "id" : "b39d7689-5188-4a1f-a7ad-fc859148b270",
    "prId" : 7431,
    "comments" : [
      {
        "id" : "5bd77bed-c431-4805-a2c2-fc1a37c0af70",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "You can also make `curl` just print the status code:\r\n```suggestion\r\n      STATUS=\"$(curl -Is -w '%{http_code}' -o /dev/null \"$TARGET_URL\")\"\r\n```",
        "createdAt" : "2020-09-17T14:44:54Z",
        "updatedAt" : "2020-09-18T11:11:36Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "9c9a9d17-1280-49e1-978a-e7f8c6c1725c",
        "parentId" : "5bd77bed-c431-4805-a2c2-fc1a37c0af70",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "Thanks for pointing that out, I was not aware of that option. I'm not going to include that in this PR, though, as I want this to be a minimal change to fix the issue from yesterday.",
        "createdAt" : "2020-09-18T11:12:23Z",
        "updatedAt" : "2020-09-18T11:12:23Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "7cc6b3ea1b9511c05913bf3720896433a9e3fd11",
    "line" : 4,
    "diffHunk" : "@@ -17,8 +17,9 @@ jobs:\n       CACHE_KEY=\"$(find ci/patch_bazel_windows -type f -print0 | sort -z | xargs -r0 md5sum | md5sum | awk '{print $1}')\"\n       TARGET=\"patch_bazel_windows/bazel-$CACHE_KEY.zip\"\n       TARGET_URL=\"https://daml-binaries.da-ext.net/$TARGET\"\n+      STATUS=\"$(curl -Is \"$TARGET_URL\" | head -1 | awk '{print $2}')\""
  },
  {
    "id" : "030b6f94-4cad-4342-843f-dc28e7bded96",
    "prId" : 5918,
    "comments" : [
      {
        "id" : "7928c6be-32f0-491f-bd00-114f36680eba",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "```suggestion\r\n      # Note (MK) For some reason, the `zip` from chocolatey seems to result in \r\n      # a “zip file structure invalid” error. I’ve tried adding msys to PATH so the Bazel\r\n      # rules pick up `zip` from msys but that broke other things. So for now\r\n      # we skip the final Bazel rule to build the self-extracting exe and instead\r\n      # call `zip` from msys separately.\r\n      /c/tools/msys64/msys2_shell.cmd -defterm -no-start -here -c \"cat bazel-bin/src/main/cpp/client.exe bazel-bin/src/package_jdk_minimal.zip > bazel.exe && zip -A bazel.exe\"\r\n```\r\nI’m sure I’ll forget why we do this so adding my notes here seems useful :slightly_smiling_face: ",
        "createdAt" : "2020-05-12T12:47:02Z",
        "updatedAt" : "2020-05-12T16:52:11Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "121ce14ef114457d1b9439c006adf20aad4a8029",
    "line" : 70,
    "diffHunk" : "@@ -0,0 +1,99 @@\n+# Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+# SPDX-License-Identifier: Apache-2.0\n+\n+parameters:\n+- name: final_job_name\n+\n+jobs:\n+\n+- job: patch_bazel_pre_check\n+  pool:\n+    name: linux-pool\n+  steps:\n+  - checkout: self\n+  - bash: |\n+      set -euo pipefail\n+\n+      CACHE_KEY=\"$(md5sum $(find ci/patch_bazel_windows -type f) | md5sum | awk '{print $1}')\"\n+      TARGET=\"patch_bazel_windows/bazel-$CACHE_KEY.zip\"\n+      TARGET_URL=\"https://daml-binaries.da-ext.net/$TARGET\"\n+\n+      if [ \"200\" = \"$(curl -Is \"$TARGET_URL\" | awk '{print $2}')\" ]; then\n+          SHOULD_RUN=false\n+      else\n+          SHOULD_RUN=true\n+      fi\n+      echo \"##vso[task.setvariable variable=cache_key;isOutput=true]$CACHE_KEY\"\n+      echo \"##vso[task.setvariable variable=should_run;isOutput=true]$SHOULD_RUN\"\n+      echo \"##vso[task.setvariable variable=target;isOutput=true]$TARGET\"\n+      echo \"##vso[task.setvariable variable=target_url;isOutput=true]$TARGET_URL\"\n+    name: out\n+\n+- job: patch_bazel_compile\n+  dependsOn:\n+    - patch_bazel_pre_check\n+  variables:\n+    cache_key: $[ dependencies.patch_bazel_pre_check.outputs['out.cache_key'] ]\n+    bazel_base_version: 2.1.0\n+  condition: and(succeeded(), eq(dependencies.patch_bazel_pre_check.outputs['out.should_run'], 'true'))\n+  pool:\n+    vmImage: windows-2019\n+  steps:\n+  - checkout: self\n+  - bash: |\n+      git clone https://github.com/bazelbuild/bazel.git\n+      cd bazel\n+      git checkout $(bazel_base_version)\n+      git apply --ignore-space-change --ignore-whitespace --whitespace=nowarn < ../ci/patch_bazel_windows/patch-bazel\n+  - powershell: |\n+      choco install msys2 --noprogress --yes\n+      choco install zip --noprogress --yes\n+  - powershell: |\n+      C:\\tools\\msys64\\usr\\bin\\pacman -S zip --noconfirm\n+  - bash: |\n+      set -euo pipefail\n+      cd bazel\n+      bazel build src/main/cpp:client src:package-zip_jdk_minimal -c opt --stamp --embed_label $(bazel_base_version)-patched-$(cache_key)\n+      /c/tools/msys64/msys2_shell.cmd -defterm -no-start -here -c \"cat bazel-bin/src/main/cpp/client.exe bazel-bin/src/package_jdk_minimal.zip > bazel.exe && zip -A bazel.exe\""
  }
]