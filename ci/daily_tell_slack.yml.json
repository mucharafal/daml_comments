[
  {
    "id" : "b278fbf4-77fb-4eeb-b8cd-f738bf940771",
    "prId" : 6267,
    "comments" : [
      {
        "id" : "a757c625-4e2e-4385-9885-ae76b95c16fd",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "I donâ€™t understand the escaping here. iirc (and I did briefly look at the yaml spec to confirm) you only have to escape single quotes within a single-quoted string.",
        "createdAt" : "2020-06-09T06:44:40Z",
        "updatedAt" : "2020-06-09T06:45:26Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "21d1cf79-fdbf-4a3e-9211-62c5aaa5a757",
        "parentId" : "a757c625-4e2e-4385-9885-ae76b95c16fd",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "They're escaped for Bash, not for YAML. I need the quotes in there to produce valid JSON.",
        "createdAt" : "2020-06-09T10:23:43Z",
        "updatedAt" : "2020-06-09T10:23:43Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "7a6a3b97-0575-4e20-ad73-547cb5d7288e",
        "parentId" : "a757c625-4e2e-4385-9885-ae76b95c16fd",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "Elaborating a little bit, we use this here:\r\n```\r\nMESSAGE=\"${{ parameters['success-message'] }}\"\r\n```\r\nand want that to Azure-resolve to\r\n```\r\nMESSAGE=\"\\\"$(Agent.JobName) passed: $COMMIT_LINK\\\"\"\r\n```\r\nso we have quotes in there for when we call\r\n```\r\nPAYLOAD=\"{\\\"text\\\":$MESSAGE}\"\r\n```\r\nso we produce valid JSON.\r\n\r\nNow, you'd think we could have just kept the existing form of\r\n```\r\nPAYLOAD=\"{\\\"text\\\":\\\"$MESSAGE\\n\\\"}\"\r\n```\r\nto have explicit quotes at the point of use. The problem with that is that the alternative, for the perf job, is produced by `jq`, which has to produce a valid JSON string (so it includes all the relevant escaping), and that has embedded quotes. So we need the default case to have embedded quotes too.",
        "createdAt" : "2020-06-09T10:32:37Z",
        "updatedAt" : "2020-06-09T10:32:37Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "890bb472-4ecc-4aa9-997f-6f499e5629ed",
        "parentId" : "a757c625-4e2e-4385-9885-ae76b95c16fd",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Makes sense, thanks for the explanation!",
        "createdAt" : "2020-06-09T10:33:30Z",
        "updatedAt" : "2020-06-09T10:33:30Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "333ffadfd657b84314cd66a9ed4d901c4cbe4510",
    "line" : 5,
    "diffHunk" : "@@ -2,7 +2,7 @@\n # SPDX-License-Identifier: Apache-2.0\n \n parameters:\n-  success-message: '\"$(Agent.JobName) passed: $COMMIT_LINK\"'\n+  success-message: '\\\"$(Agent.JobName) passed: $COMMIT_LINK\\\"'"
  },
  {
    "id" : "c7a5528e-1487-4578-bdab-d8c2a9357ba6",
    "prId" : 6221,
    "comments" : [
      {
        "id" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "If you want to fail eagerly if this variable doesn't exist, you could add:\r\n\r\n```suggestion\r\n    [ -n \"$(Build.SourceBranchName)\" ]\r\n    if [ \"$(Build.SourceBranchName)\" = \"master\" ]; then\r\n```",
        "createdAt" : "2020-06-04T09:25:25Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "47025590-d6a9-4d50-8872-eb6cb5975c16",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Is `set -u` not enough for that?",
        "createdAt" : "2020-06-04T09:26:57Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "06ddfc96-d59f-4893-bf61-c80556df0d96",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "Clearly `set -u` is not working here, as the jobs are still green on Azure despite the error message.",
        "createdAt" : "2020-06-04T09:30:12Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "bff6e1ff-f2dc-4dda-95be-61e80d2746ac",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Nope, because this isn't a shell variable, it's an Azure Pipelines variable. It's inserted through string interpolation before the script is run, as far as I understand it.\r\n\r\nPerhaps the entire job will fail if the variable doesn't exist though. Not sure how permissive Azure is with this stuff. A quick search suggests it will either insert an empty string or \"undefined\", which seems even less useful.",
        "createdAt" : "2020-06-04T09:30:30Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "0c99a0ef-13c7-4fba-b5ae-edb522aab117",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "More layers of string interpolation solve all problems.",
        "createdAt" : "2020-06-04T09:33:44Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "7fd000e4-5cef-4822-99b7-a50f0caf9350",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "@SamirTalwar That is not how Azure works. Not sure what you searched for, but if the variable doesn't exist at the Azure level, or if the syntax is wrong (as was the case here), Azure simply does not replace anything. So in this case Bash did get the literal `\"$(variables['SourceBranchName'])\"` and that is why Bash (not Azure preprocessing) printed\r\n```\r\n/home/vsts/agent/_work/_temp/7a958ea0-e48d-4658-9200-9d933a35582a.sh: line 11: variables[Build.SourceBranchName]: command not found\r\n```\r\nfrom its subshell, of which the return status is ignored despite `-e` because we're inside a `[]` (I think).\r\n\r\nSo I don't think the `[ -n ]` will help here. From my understanding of `-e` (`-u` is irrelevant here as from Bash's perspective there is no variable involved, just a subshell, so nothing that can be unset), this should fail properly on the subshell failing:\r\n```suggestion\r\n    branch=\"$(Build.SourceBranchName)\"\r\n    if [ \"$branch\" = \"master\" ]; then\r\n```\r\nEither way, we now have the correct syntax so this will never fail (ðŸ¤ž), as the `Build.SourceBranchName` variable should always be set by Azure.",
        "createdAt" : "2020-06-04T09:44:26Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "d2ab5a60-b5b0-48fc-9338-9a21afe10d76",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Thanks for the explanation @garyverhaegen-da!",
        "createdAt" : "2020-06-04T09:52:19Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      },
      {
        "id" : "0aacf006-17ef-4288-830d-1a07b14a4428",
        "parentId" : "8132fcfb-3fd4-42e0-8e6c-93e0f8a90fef",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Aha, good to know. Thanks for the clarification!",
        "createdAt" : "2020-06-04T09:53:13Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "853bccc774bb18b9a315a29713ad931e9248d052",
    "line" : 5,
    "diffHunk" : "@@ -16,7 +16,7 @@ steps:\n         MESSAGE=${{ parameters['success-message'] }}\n     fi\n     PAYLOAD=\"{\\\"text\\\":\\\"$MESSAGE\\n\\\"}\"\n-    if [ \"$(variables['Build.SourceBranchName'])\" = \"master\" ]; then\n+    if [ \"$(Build.SourceBranchName)\" = \"master\" ]; then"
  },
  {
    "id" : "b1315fb9-cc8f-4419-841b-b91040be6409",
    "prId" : 6221,
    "comments" : [
      {
        "id" : "2d34d75f-d561-4729-a3f9-53d5aaf96542",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Probably wanna delete this line now.",
        "createdAt" : "2020-06-04T09:53:40Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "f2ded41a-3f52-4b19-a623-1ab288d2ee37",
        "parentId" : "2d34d75f-d561-4729-a3f9-53d5aaf96542",
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Iâ€™ve just gone back to my first version now.",
        "createdAt" : "2020-06-04T09:54:45Z",
        "updatedAt" : "2020-06-04T10:13:18Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "853bccc774bb18b9a315a29713ad931e9248d052",
    "line" : null,
    "diffHunk" : "@@ -16,7 +16,9 @@ steps:\n         MESSAGE=${{ parameters['success-message'] }}\n     fi\n     PAYLOAD=\"{\\\"text\\\":\\\"$MESSAGE\\n\\\"}\"\n-    if [ \"$(variables['Build.SourceBranchName'])\" = \"master\" ]; then\n+    [ -n \"$(Build.SourceBranchName)\" ]"
  },
  {
    "id" : "42187a92-205f-412f-923e-cf2040db17fa",
    "prId" : 6177,
    "comments" : [
      {
        "id" : "7b670637-bab5-457b-83c6-2437a2e7fd3f",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Doesnâ€™t matter much but you could factor this out to ensure that you are actually printing the same thing that you would send to slack.",
        "createdAt" : "2020-06-01T14:09:15Z",
        "updatedAt" : "2020-06-03T13:08:40Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "f83d5fce-924a-4715-adb7-7849b063e1e1",
        "parentId" : "7b670637-bab5-457b-83c6-2437a2e7fd3f",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "Good point, will do.",
        "createdAt" : "2020-06-01T15:06:01Z",
        "updatedAt" : "2020-06-03T13:08:40Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "fb5bf7a61c9771ea7d83018e2c15da835aa38fbf",
    "line" : null,
    "diffHunk" : "@@ -0,0 +1,28 @@\n+# Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.\n+# SPDX-License-Identifier: Apache-2.0\n+\n+parameters:\n+  success-message: '\"$(Agent.JobName) passed: $COMMIT_LINK\"'\n+\n+steps:\n+- bash: |\n+    set -euo pipefail\n+    eval \"$(dev-env/bin/dade assist)\"\n+    COMMIT_TITLE=$(git log --pretty=format:%s -n1)\n+    COMMIT_LINK=\"<https://dev.azure.com/digitalasset/daml/_build/results?buildId=$(Build.BuildId)|$COMMIT_TITLE>\"\n+    if [ \"$(Agent.JobStatus)\" != \"Succeeded\" ]; then\n+        MESSAGE=\":fire: :fire: <!here> :fire: :fire:\\n$(Agent.JobName) *FAILED*: $COMMIT_LINK\\n:fire: :fire:\"\n+    else\n+        MESSAGE=${{ parameters['success-message'] }}\n+    fi\n+    if [ \"$(variables['Build.SourceBranchName'])\" = \"master\" ]; then\n+        curl -XPOST \\\n+             -i \\\n+             -H 'Content-type: application/json' \\\n+             --data \"{\\\"text\\\":\\\"$MESSAGE\\n\\\"}\" \\\n+             $(Slack.team-daml)\n+    else\n+        echo \"{\\\"text\\\":\\\"$MESSAGE\\n\\\"}\""
  }
]