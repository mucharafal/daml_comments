[
  {
    "id" : "e8ad0d19-45e5-4a24-b4ce-5888c11d1657",
    "prId" : 7011,
    "comments" : [
      {
        "id" : "3e99c702-b2a5-4860-b2fa-254ae18e23ed",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "Given that itâ€™s here as well, I assume it is intentional.",
        "createdAt" : "2020-08-05T14:23:56Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "9f4599d35cb51733847572c3264d234d481fd349",
    "line" : 18,
    "diffHunk" : "@@ -16,54 +16,91 @@ jobs:\n - job: open_release_pr\n   timeoutInMinutes: 60\n   pool:\n-    name: linux-pool\n-    demands: assignment -equals default\n+    vmImage: ubuntu-latest\n   steps:\n   - checkout: self\n     persistCredentials: true\n-  - bash: ci/dev-env-install.sh\n   - bash: |\n-      set -euo pipefail\n-      eval \"$(./dev-env/bin/dade-assist)\"\n+      set -euxo pipefail\n \n-      setvar() {\n-          echo \"Setting '$1' to '$2'\"\n-          echo \"##vso[task.setvariable variable=$1;isOutput=true]$2\"\n+      if header=$(git config 'http.https://github.com/digital-asset/daml.extraheader'); then"
  },
  {
    "id" : "0a226031-245c-4b27-9e13-58786ef7c076",
    "prId" : 7011,
    "comments" : [
      {
        "id" : "02ff546f-b079-4110-a47a-53820f283dcf",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "If you're wary about special characters in the title or body, you could do something like this:\r\n\r\n```sh\r\njq -n --arg branch \"$branch\" --arg title \"$title\" --arg body \"$body\" '{\"title\": $title, \"head\": $branch, \"base\": \"master\", \"body\": $body}' \\\r\n  | curl ... -d @- https://...\r\n```",
        "createdAt" : "2020-08-05T14:36:54Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "5f3bd3f7-36f2-4299-9648-7bdb2a8f6389",
        "parentId" : "02ff546f-b079-4110-a47a-53820f283dcf",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "I did not know `jq` had such a syntax. Thanks!",
        "createdAt" : "2020-08-05T14:43:33Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "9f4599d35cb51733847572c3264d234d481fd349",
    "line" : null,
    "diffHunk" : "@@ -16,54 +16,97 @@ jobs:\n - job: open_release_pr\n   timeoutInMinutes: 60\n   pool:\n-    name: linux-pool\n-    demands: assignment -equals default\n+    vmImage: ubuntu-latest\n   steps:\n   - checkout: self\n     persistCredentials: true\n-  - bash: ci/dev-env-install.sh\n   - bash: |\n-      set -euo pipefail\n-      eval \"$(./dev-env/bin/dade-assist)\"\n+      set -euxo pipefail\n \n-      setvar() {\n-          echo \"Setting '$1' to '$2'\"\n-          echo \"##vso[task.setvariable variable=$1;isOutput=true]$2\"\n+      if header=$(git config 'http.https://github.com/digital-asset/daml.extraheader'); then\n+          AUTH=\"$header\"\n+      else\n+          AUTH=\"Authorization: basic $(git config remote.origin.url | grep -o '://.*:.*@' | cut -c4- | rev | cut -c2- | rev)\"\n+      fi\n+\n+      BASE_SHA=$(git rev-parse HEAD)\n+      az extension add --name azure-devops\n+      echo \"$(System.AccessToken)\" | az devops login --org \"https://dev.azure.com/digitalasset\"\n+\n+      reset() {\n+          git checkout -f $BASE_SHA\n+          git reset --hard\n       }\n+      open_pr() {\n+          local branch title body out pr_number\n+          branch=$1\n+          title=\"$2\"\n+          body=\"$3\"\n+          out=$4\n+          git branch -D $branch || true\n+          git checkout -b $branch\n+          git add .\n+          git -c user.name=\"Azure Pipelines DAML Build\" \\\n+              -c user.email=\"support@digitalasset.com\" \\\n+              commit \\\n+              -m \"$(printf \"$title\\n\\n$body\\n\\nCHANGELOG_BEGIN\\nCHANGELOG_END\\n\")\"\n+          git push origin $branch:$branch\n+          pr_number=$(curl -H \"Content-Type: application/json\" \\\n+                           -H \"$AUTH\" \\\n+                           --silent \\\n+                           --location \\\n+                           -d \"{\\\"title\\\": \\\"$title\\\", \\\"head\\\": \\\"$branch\\\", \\\"base\\\": \\\"master\\\", \\\"body\\\": \\\"$body\\\"}\" \\"
  },
  {
    "id" : "8a545d97-233c-4709-bbf9-5706c7c5523c",
    "prId" : 7011,
    "comments" : [
      {
        "id" : "481f6e35-6073-46fb-92f8-387e22929cb6",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "You don't need to get `cat` involved here.\r\n\r\n```suggestion\r\n          (tail -n +2 $tmp; head -1 $tmp) > release/rotation\r\n```",
        "createdAt" : "2020-08-05T14:38:18Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "c18ff063-c624-4f7e-8d68-978d0fcfa814",
        "parentId" : "481f6e35-6073-46fb-92f8-387e22929cb6",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "You always want to oust my cats. ðŸ˜¿",
        "createdAt" : "2020-08-05T14:44:48Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "31fde38b-5126-4d5b-b5f1-3b89873f9cd0",
        "parentId" : "481f6e35-6073-46fb-92f8-387e22929cb6",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Let the cat sleep. It's had a hard day.",
        "createdAt" : "2020-08-05T15:13:33Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "9f4599d35cb51733847572c3264d234d481fd349",
    "line" : null,
    "diffHunk" : "@@ -16,54 +16,97 @@ jobs:\n - job: open_release_pr\n   timeoutInMinutes: 60\n   pool:\n-    name: linux-pool\n-    demands: assignment -equals default\n+    vmImage: ubuntu-latest\n   steps:\n   - checkout: self\n     persistCredentials: true\n-  - bash: ci/dev-env-install.sh\n   - bash: |\n-      set -euo pipefail\n-      eval \"$(./dev-env/bin/dade-assist)\"\n+      set -euxo pipefail\n \n-      setvar() {\n-          echo \"Setting '$1' to '$2'\"\n-          echo \"##vso[task.setvariable variable=$1;isOutput=true]$2\"\n+      if header=$(git config 'http.https://github.com/digital-asset/daml.extraheader'); then\n+          AUTH=\"$header\"\n+      else\n+          AUTH=\"Authorization: basic $(git config remote.origin.url | grep -o '://.*:.*@' | cut -c4- | rev | cut -c2- | rev)\"\n+      fi\n+\n+      BASE_SHA=$(git rev-parse HEAD)\n+      az extension add --name azure-devops\n+      echo \"$(System.AccessToken)\" | az devops login --org \"https://dev.azure.com/digitalasset\"\n+\n+      reset() {\n+          git checkout -f $BASE_SHA\n+          git reset --hard\n       }\n+      open_pr() {\n+          local branch title body out pr_number\n+          branch=$1\n+          title=\"$2\"\n+          body=\"$3\"\n+          out=$4\n+          git branch -D $branch || true\n+          git checkout -b $branch\n+          git add .\n+          git -c user.name=\"Azure Pipelines DAML Build\" \\\n+              -c user.email=\"support@digitalasset.com\" \\\n+              commit \\\n+              -m \"$(printf \"$title\\n\\n$body\\n\\nCHANGELOG_BEGIN\\nCHANGELOG_END\\n\")\"\n+          git push origin $branch:$branch\n+          pr_number=$(curl -H \"Content-Type: application/json\" \\\n+                           -H \"$AUTH\" \\\n+                           --silent \\\n+                           --location \\\n+                           -d \"{\\\"title\\\": \\\"$title\\\", \\\"head\\\": \\\"$branch\\\", \\\"base\\\": \\\"master\\\", \\\"body\\\": \\\"$body\\\"}\" \\\n+                           https://api.github.com/repos/digital-asset/daml/pulls \\\n+                      | jq '.number')\n+          az pipelines build queue \\\n+              --branch $branch \\\n+              --definition-name \"digital-asset.daml\" \\\n+              --org \"https://dev.azure.com/digitalasset\" \\\n+              --project daml\n+          echo $pr_number > $out\n+      }\n+      assign_and_label() {\n+          local pr_number, assignee\n+          pr_number=$1\n+          assignee=$2\n+          curl -H \"Content-Type: application/json\" \\\n+               -X PATCH \\\n+               -u $AUTH \\\n+               --silent \\\n+               --location \\\n+               -d \"{\\\"assignees\\\": [\\\"$assignee\\\"], \\\"labels\\\": [\\\"Standard-Change\\\"]}\" \\\n+               https://api.github.com/repos/digital-asset/daml/issues/$pr_number\n+          # For the purposes of \"common\" features, such as assignees and\n+          # labels, PRs are issues as far as the GH API is concerned.\n+      }\n+      rotate() {\n+          local tmp\n+          tmp=$(mktemp)\n+          cp release/rotation $tmp\n+          cat <(tail -n +2 $tmp) <(head -1 $tmp) > release/rotation"
  },
  {
    "id" : "6da0dcf7-a802-485c-bce0-a81006370257",
    "prId" : 7011,
    "comments" : [
      {
        "id" : "763c2ddb-2cac-48ac-a511-4c847604c8a4",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "This doesn't seem to be used anywhere. I might be mistaken.",
        "createdAt" : "2020-08-05T14:41:32Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "b53001d0-5f07-4835-a6cf-02ab3d9c9f29",
        "parentId" : "763c2ddb-2cac-48ac-a511-4c847604c8a4",
        "author" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "body" : "It's used to get the PR number so we can assign the Standard-Change label to it, assign the release handler, and mention it in the second PR message.",
        "createdAt" : "2020-08-05T14:46:34Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "garyverhaegen-da",
          "name" : "Gary Verhaegen",
          "avatarUrl" : "https://avatars0.githubusercontent.com/u/45561385?u=eb17386ea66edbd0cd449e33b2d291bf5a1b51cb&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      },
      {
        "id" : "15bc668a-0b61-4ee9-8d56-a5c0347d807b",
        "parentId" : "763c2ddb-2cac-48ac-a511-4c847604c8a4",
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Aha, it's unused in the second `open_pr`, but not the first. Can I suggest making it an optional parameter, rather than calling `mktemp`?\r\n\r\n```suggestion\r\n          if [[ -n \"$out\" ]]; then\r\n            echo $pr_number > $out\r\n          fi\r\n```",
        "createdAt" : "2020-08-05T15:14:33Z",
        "updatedAt" : "2020-08-05T16:25:24Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
          {
            "value" : "outdated"
          }
        ]
      }
    ],
    "commit" : "9f4599d35cb51733847572c3264d234d481fd349",
    "line" : null,
    "diffHunk" : "@@ -16,54 +16,97 @@ jobs:\n - job: open_release_pr\n   timeoutInMinutes: 60\n   pool:\n-    name: linux-pool\n-    demands: assignment -equals default\n+    vmImage: ubuntu-latest\n   steps:\n   - checkout: self\n     persistCredentials: true\n-  - bash: ci/dev-env-install.sh\n   - bash: |\n-      set -euo pipefail\n-      eval \"$(./dev-env/bin/dade-assist)\"\n+      set -euxo pipefail\n \n-      setvar() {\n-          echo \"Setting '$1' to '$2'\"\n-          echo \"##vso[task.setvariable variable=$1;isOutput=true]$2\"\n+      if header=$(git config 'http.https://github.com/digital-asset/daml.extraheader'); then\n+          AUTH=\"$header\"\n+      else\n+          AUTH=\"Authorization: basic $(git config remote.origin.url | grep -o '://.*:.*@' | cut -c4- | rev | cut -c2- | rev)\"\n+      fi\n+\n+      BASE_SHA=$(git rev-parse HEAD)\n+      az extension add --name azure-devops\n+      echo \"$(System.AccessToken)\" | az devops login --org \"https://dev.azure.com/digitalasset\"\n+\n+      reset() {\n+          git checkout -f $BASE_SHA\n+          git reset --hard\n       }\n+      open_pr() {\n+          local branch title body out pr_number\n+          branch=$1\n+          title=\"$2\"\n+          body=\"$3\"\n+          out=$4\n+          git branch -D $branch || true\n+          git checkout -b $branch\n+          git add .\n+          git -c user.name=\"Azure Pipelines DAML Build\" \\\n+              -c user.email=\"support@digitalasset.com\" \\\n+              commit \\\n+              -m \"$(printf \"$title\\n\\n$body\\n\\nCHANGELOG_BEGIN\\nCHANGELOG_END\\n\")\"\n+          git push origin $branch:$branch\n+          pr_number=$(curl -H \"Content-Type: application/json\" \\\n+                           -H \"$AUTH\" \\\n+                           --silent \\\n+                           --location \\\n+                           -d \"{\\\"title\\\": \\\"$title\\\", \\\"head\\\": \\\"$branch\\\", \\\"base\\\": \\\"master\\\", \\\"body\\\": \\\"$body\\\"}\" \\\n+                           https://api.github.com/repos/digital-asset/daml/pulls \\\n+                      | jq '.number')\n+          az pipelines build queue \\\n+              --branch $branch \\\n+              --definition-name \"digital-asset.daml\" \\\n+              --org \"https://dev.azure.com/digitalasset\" \\\n+              --project daml\n+          echo $pr_number > $out"
  },
  {
    "id" : "8a64e60a-57ce-4da8-88e4-003c0b153360",
    "prId" : 6964,
    "comments" : [
      {
        "id" : "3c87c1c0-cd7b-491c-8608-f467c25df127",
        "parentId" : null,
        "author" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "body" : "Perhaps put quotes around `$(branch)` so that if it doesn't show up, we get a more meaningful error message?\r\n\r\n```suggestion\r\n      az pipelines build queue --branch \"$(branch)\" --definition-name \"digital-asset.daml\" --org \"https://dev.azure.com/digitalasset\" --project daml\r\n```\r\n\r\nI want to see an error message along the lines of `invalid branch: ''`, not `could not parse the argument 'digital-asset.daml'`.",
        "createdAt" : "2020-08-03T13:55:39Z",
        "updatedAt" : "2020-08-03T13:55:48Z",
        "lastEditedBy" : {
          "login" : "SamirTalwar-DA",
          "name" : "Samir Talwar",
          "avatarUrl" : "https://avatars2.githubusercontent.com/u/60356447?u=f6cdfccc6ea4254bd7c212099bbac2c27a00a28c&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "bcf26e84893e9fef92443432754c4ac953a151c5",
    "line" : 31,
    "diffHunk" : "@@ -46,3 +51,19 @@ jobs:\n            --location \\\n            -d \"{\\\"title\\\": \\\"release $RELEASE\\\", \\\"head\\\": \\\"$BRANCH\\\", \\\"base\\\": \\\"master\\\", \\\"body\\\": \\\"This PR has been created by a script, which is not very smart and does not have all the context. Please do double-check that the version prefix is correct before merging.\\\"}\" \\\n            https://api.github.com/repos/digital-asset/daml/pulls\n+\n+      setvar \"branch\" \"$BRANCH\"\n+    name: out\n+- job: trigger_ci\n+  dependsOn: open_release_pr\n+  pool:\n+    vmImage: \"ubuntu-latest\"\n+  variables:\n+    branch: $[ dependencies.open_release_pr.outputs['out.branch'] ]\n+  steps:\n+  - checkout: none\n+  - bash: |\n+      set -euo pipefail\n+      az extension add --name azure-devops\n+      echo \"$(System.AccessToken)\" | az devops login --org \"https://dev.azure.com/digitalasset\"\n+      az pipelines build queue --branch $(branch) --definition-name \"digital-asset.daml\" --org \"https://dev.azure.com/digitalasset\" --project daml"
  },
  {
    "id" : "b1125af6-1965-4c6e-b4da-6f6aa5f1d412",
    "prId" : 6859,
    "comments" : [
      {
        "id" : "7f53b8ad-7853-4fd8-8fe7-5f03e0a6c853",
        "parentId" : null,
        "author" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "body" : "It looks like we need a new pipeline for this. At the moment it doesnâ€™t seem to get triggered from anywhere.",
        "createdAt" : "2020-07-29T07:21:53Z",
        "updatedAt" : "2020-07-29T07:21:53Z",
        "lastEditedBy" : {
          "login" : "cocreature",
          "name" : "Moritz Kiefer",
          "avatarUrl" : "https://avatars1.githubusercontent.com/u/1313584?u=7864421488a876940b33e865c4b0091925617ca7&v=4"
        },
        "tags" : [
        ]
      }
    ],
    "commit" : "1dcc002b38f1f101a91dffe08b4ac1a241a94085",
    "line" : 1,
    "diffHunk" : "@@ -0,0 +1,48 @@\n+# Copyright (c) 2020 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved."
  }
]